<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian F. Rodríguez Casas">

<title>Replication Report — Brown &amp; MacKay (2023)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Report_files/libs/quarto-html/quarto.js"></script>
<script src="Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Report_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Report_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation"><span class="header-section-number">2</span> 1. Motivation</a></li>
  <li><a href="#selecting-a-paper-to-replicate" id="toc-selecting-a-paper-to-replicate" class="nav-link" data-scroll-target="#selecting-a-paper-to-replicate"><span class="header-section-number">3</span> 2. Selecting a Paper to Replicate</a></li>
  <li><a href="#the-choice" id="toc-the-choice" class="nav-link" data-scroll-target="#the-choice"><span class="header-section-number">4</span> 3. The Choice</a></li>
  <li><a href="#procedure" id="toc-procedure" class="nav-link" data-scroll-target="#procedure"><span class="header-section-number">5</span> 4. Procedure</a></li>
  <li><a href="#challenges-and-issues" id="toc-challenges-and-issues" class="nav-link" data-scroll-target="#challenges-and-issues"><span class="header-section-number">6</span> 5. Challenges and Issues</a></li>
  <li><a href="#replication-process" id="toc-replication-process" class="nav-link" data-scroll-target="#replication-process"><span class="header-section-number">7</span> 6. Replication Process</a>
  <ul class="collapse">
  <li><a href="#tools-used" id="toc-tools-used" class="nav-link" data-scroll-target="#tools-used"><span class="header-section-number">7.1</span> Tools Used</a></li>
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries"><span class="header-section-number">7.2</span> Libraries</a></li>
  <li><a href="#understanding-the-data-and-folder-structure" id="toc-understanding-the-data-and-folder-structure" class="nav-link" data-scroll-target="#understanding-the-data-and-folder-structure"><span class="header-section-number">7.3</span> Understanding the Data and Folder Structure</a></li>
  <li><a href="#rebuilding-figures" id="toc-rebuilding-figures" class="nav-link" data-scroll-target="#rebuilding-figures"><span class="header-section-number">7.4</span> Rebuilding Figures</a></li>
  <li><a href="#reproducing-tables" id="toc-reproducing-tables" class="nav-link" data-scroll-target="#reproducing-tables"><span class="header-section-number">7.5</span> Reproducing Tables</a></li>
  <li><a href="#debugging" id="toc-debugging" class="nav-link" data-scroll-target="#debugging"><span class="header-section-number">7.6</span> Debugging</a></li>
  </ul></li>
  <li><a href="#remaining-issues-and-open-challenges" id="toc-remaining-issues-and-open-challenges" class="nav-link" data-scroll-target="#remaining-issues-and-open-challenges"><span class="header-section-number">8</span> 7. Remaining Issues and Open Challenges</a></li>
  <li><a href="#what-wed-do-with-more-time" id="toc-what-wed-do-with-more-time" class="nav-link" data-scroll-target="#what-wed-do-with-more-time"><span class="header-section-number">9</span> 8. What We’d Do with More Time</a></li>
  <li><a href="#reflections-on-the-process" id="toc-reflections-on-the-process" class="nav-link" data-scroll-target="#reflections-on-the-process"><span class="header-section-number">10</span> 9. Reflections on the Process</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Report.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Replication Report — Brown &amp; MacKay (2023)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian F. Rodríguez Casas </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="abstract" class="level1 unnumbered">
<h1 class="unnumbered">Abstract</h1>
<p>The process required us to pay close attention to how the authors structured their simulation, modeled their data, and understood the market dynamics. While we successfully replicated most outputs, a few figures didn’t match exactly due to limitations in the replication data and differences in how certain functions behave in R compared to Stata.</p>
<p>Beyond the technical challenges, the replication project helped us not only deepen our coding knowledge, but also to understand how algorithmic pricing influences competitive outcomes, especially the tension between learning and collusion. Furthermore, it gave us a clearer view of how to structure academic research with the aid of R, insight that will be valuable when writing our master’s thesis.</p>
<p>The following sections walk through our workflow, key coding decisions, and the main insights we gathered throughout the process.</p>
</section>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>At first glance, replicating an academic paper might seem easy on the surface: choose a topic, pick a paper, review its graphs and tables, assess its difficulty, analyze its replication package, data sources, code, match the results, and publish. But in reality, it rarely works out that cleanly.</p>
<p>This report offers a clear, transparent, and honest account of our attempt to replicate the paper <em>Competition in Pricing Algorithms</em> by <span class="citation" data-cites="Brown2023">Brown and MacKay (<a href="#ref-Brown2023" role="doc-biblioref">2023</a>)</span>, a study that explores how businesses that use AI-based pricing tools can unintentionally (or intentionally) reduce competition over time. In the authors’ words the study aims to:</p>
<blockquote class="blockquote">
<p>“illustrate how pricing algorithms can generate supracompetitive prices through novel, non-collusive mechanisms. Frequency, commitment, and asymmetry in pricing technology allow firms to support higher prices in competitive (Markov perfect) equilibrium”</p>
</blockquote>
<blockquote class="blockquote">
<p><span class="citation" data-cites="Brown2023">(<a href="#ref-Brown2023" role="doc-biblioref">Brown and MacKay 2023, 2</a>)</span></p>
</blockquote>
</section>
<section id="motivation" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 1. Motivation</h1>
<p>Our goal was to understand how we could replicate a paper from scratch using software, especially by reverse-engineering code written in a language we hadn’t seen before — Stata — and recreating it using R.</p>
<p>We wanted to internalize the original authors’ decisions and replicate their analytical process with full transparency and logic in R.</p>
</section>
<section id="selecting-a-paper-to-replicate" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> 2. Selecting a Paper to Replicate</h1>
<p>We considered two options:</p>
<ol type="1">
<li><strong>A Reputational Theory of Firm Dynamics</strong> (Board &amp; Meyer-ter-Vehn, 2022)<br>
</li>
<li><strong>Competition in Pricing Algorithms</strong> (Brown &amp; MacKay, 2023)</li>
</ol>
<p>While the first paper seemed easier, we realized that it relied on simulations and had its own hidden complexities. The second paper looked more complex, but the authors provided a detailed README and clearly structured replication package, including <code>07_summary_stats.do</code>, which we found extremely helpful.</p>
<p>Ultimately, we chose Brown &amp; MacKay’s paper due to the richness of the data and the detailed documentation.</p>
</section>
<section id="the-choice" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> 3. The Choice</h1>
<p>The deciding factor wasn’t complexity, but substance. Brown &amp; MacKay’s work analyzes real pricing data and market behavior in a way that felt directly relevant.</p>
<p>Despite early challenges (matching plot styles, interpreting Stata commands, crashes in R), we successfully replicated key outputs and learned the value of reproducible research and cross-language translation.</p>
</section>
<section id="procedure" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> 4. Procedure</h1>
<p>We divided our project into phases:</p>
<ul>
<li>Understanding the paper<br>
</li>
<li>Dividing the work among team members<br>
</li>
<li>Studying the replication package and README<br>
</li>
<li>Analyzing <code>07_summary_stats.do</code><br>
</li>
<li>Translating Stata code to R<br>
</li>
<li>Rebuilding visualizations and summary statistics</li>
</ul>
<p>To understand the Stata code, we read it line by line, ran small chunks, and checked outputs. We gradually built up a mirrored structure in R. Publishing to GitHub gave us visibility, transparency, and a good team workflow.</p>
</section>
<section id="challenges-and-issues" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> 5. Challenges and Issues</h1>
<p>Key challenges included:</p>
<ol type="1">
<li>Teamwork with someone working remotely across time zones<br>
</li>
<li>Interpreting Stata scripts<br>
</li>
<li>Handling GitHub publishing issues<br>
</li>
<li>Avoiding structural issues (e.g.&nbsp;misplaced index files)<br>
</li>
<li>RStudio crashing under memory stress<br>
</li>
<li>Fine-tuning ggplot2 visualizations</li>
</ol>
<p>Translation from Stata to R was not always 1-to-1. Many Stata commands have no R equivalent, and formatting figures to match the paper was a tedious but valuable learning experience.</p>
</section>
<section id="replication-process" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> 6. Replication Process</h1>
<p>We replicated:</p>
<ul>
<li><strong>Figure 1</strong>: Time series of prices across retailers<br>
</li>
<li><strong>Table 1</strong>: Daily statistics for hourly price data</li>
</ul>
<section id="tools-used" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="tools-used"><span class="header-section-number">7.1</span> Tools Used</h2>
<ul>
<li><strong>R</strong>: Data analysis and visualization<br>
</li>
<li><strong>Quarto</strong>: For publishing<br>
</li>
<li><strong>GitHub Pages</strong>: For sharing results</li>
</ul>
</section>
<section id="libraries" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="libraries"><span class="header-section-number">7.2</span> Libraries</h2>
<ul>
<li><code>haven</code>: Read <code>.dta</code> files from Stata<br>
</li>
<li><code>dplyr</code>: Data manipulation<br>
</li>
<li><code>ggplot2</code>: Plotting<br>
</li>
<li><code>janitor</code>: Cleaning column names<br>
</li>
<li><code>patchwork</code>: For aligning plots<br>
</li>
<li><code>gt</code>: For tables</li>
</ul>
</section>
<section id="understanding-the-data-and-folder-structure" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="understanding-the-data-and-folder-structure"><span class="header-section-number">7.3</span> Understanding the Data and Folder Structure</h2>
<p>The structure of the replication package included folders for <code>data/</code>, <code>output/</code>, and <code>programs/</code>. The Stata script <code>07_summary_stats.do</code> was central.</p>
<p>We decoded the logic of this script using ChatGPT and manual trial/error, then rebuilt the pipeline in R with tidyverse code.</p>
</section>
<section id="rebuilding-figures" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="rebuilding-figures"><span class="header-section-number">7.4</span> Rebuilding Figures</h2>
<p>Replicating <strong>Figure 2</strong> took effort due to:</p>
<ul>
<li>Matching multi-line styles<br>
</li>
<li>Aligning colors, axis breaks, layout<br>
</li>
<li>Using <code>plot_layout()</code> from patchwork for side-by-side layout<br>
</li>
<li>Careful filtering and x-axis limits</li>
</ul>
<p>Final figures used <code>ggsave()</code> for reproducibility.</p>
</section>
<section id="reproducing-tables" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="reproducing-tables"><span class="header-section-number">7.5</span> Reproducing Tables</h2>
<p>For <strong>Table 1</strong>, we:</p>
<ol type="1">
<li>Collapsed data to product-date level<br>
</li>
<li>Aggregated to website-date level<br>
</li>
<li>Created final summaries with averages<br>
</li>
<li>Added a “Total” row<br>
</li>
<li>Used <code>gt()</code> and transposition to format the output</li>
</ol>
<p>Even though we didn’t include bootstrapped standard errors, the descriptive statistics closely matched.</p>
</section>
<section id="debugging" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="debugging"><span class="header-section-number">7.6</span> Debugging</h2>
<p>Matching numbers exactly was hard due to:</p>
<ul>
<li>Different defaults in R vs.&nbsp;Stata<br>
</li>
<li>Rounding inconsistencies<br>
</li>
<li>Handling of missing values</li>
</ul>
<p>We followed strict filtering rules and used consistent naming via <code>janitor::clean_names()</code> to minimize discrepancies.</p>
</section>
</section>
<section id="remaining-issues-and-open-challenges" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> 7. Remaining Issues and Open Challenges</h1>
<p>While we replicated the core results, we had limitations:</p>
<ul>
<li>Undocumented parts in Stata code<br>
</li>
<li>Minor mismatches in decimal rounding<br>
</li>
<li>ggplot2 vs.&nbsp;Stata styling differences<br>
</li>
<li>Some trial-and-error guesses due to undocumented logic</li>
</ul>
<p>We focused on logic and reproducibility more than perfect visual fidelity.</p>
</section>
<section id="what-wed-do-with-more-time" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> 8. What We’d Do with More Time</h1>
<p>Given more time, we would:</p>
<ul>
<li>Audit each transformation step<br>
</li>
<li>Modularize our R code into reusable functions<br>
</li>
<li>Automate figure checking with <code>vdiffr</code><br>
</li>
<li>Apply the code to another industry</li>
</ul>
</section>
<section id="reflections-on-the-process" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> 9. Reflections on the Process</h1>
<p>This project showed us how non-linear, trial-based, and conceptually rich replication work can be. Translating workflows across languages isn’t just technical — it’s about reconstructing decisions.</p>
<p>Even when we matched outputs, we learned how logic and intention matter more than exact syntax. Replicating the <strong>reasoning</strong> behind the paper gave us insight into both research and technical thinking.</p>
<hr>
<blockquote class="blockquote">
<p><em>“Successful replication isn’t about looking identical. It’s about reaching the same conclusion through sound logic and thoughtful reconstruction.”</em></p>
</blockquote>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Brown2023" class="csl-entry" role="listitem">
Brown, Zach Y., and Alexander MacKay. 2023. <span>“Competition in Pricing Algorithms.”</span> <em>American Economic Journal: Microeconomics</em> 15 (2): 109–56. <a href="https://doi.org/10.1257/mic.20210158">https://doi.org/10.1257/mic.20210158</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>